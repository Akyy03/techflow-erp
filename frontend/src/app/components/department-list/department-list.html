<div style="padding: 40px; max-width: 1400px; margin: 0 auto">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px">
    <div>
      <h1 style="color: white; margin: 0; font-size: 2rem; font-weight: 800; letter-spacing: -1px">
        ORGANIZATION <span style="color: #6366f1">UNITS</span>
      </h1>
      <p style="color: #64748b; margin-top: 5px; font-weight: 500">Manage and structure your company departments</p>
    </div>
    <button (click)="openAddModal()" class="tf-btn-primary" style="width: auto; padding: 12px 24px; display: flex; align-items: center; gap: 8px">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" /></svg>
      Create New Unit
    </button>
  </div>

  <div class="dept-grid">
    @for (dept of departments(); track dept.id) {
      <div class="bento-card">
        <div style="display: flex; justify-content: flex-end; gap: 8px; margin-bottom: -10px">
          <button (click)="openEditModal(dept)" class="card-action-btn edit" title="Edit Unit">
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7M18.5 2.5a2.121 2.121 0 113 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
          </button>
          <button (click)="onDelete(dept.id)" class="card-action-btn delete" title="Delete Unit">
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
          </button>
        </div>
        <div style="display: flex; align-items: flex-start; gap: 16px; margin-top: 10px">
          <div class="unit-icon">{{ dept.name[0] }}</div>
          <div style="flex: 1">
            <div class="tf-label">Department Name</div>
            <h3 style="color: white; margin: 0; font-size: 1.3rem; font-weight: 700">{{ dept.name }}</h3>
            <span class="unit-id">ID_SYS_0{{ dept.id }}</span>
          </div>
        </div>
        <div style="margin: 20px 0">
          <div class="tf-label">Objective</div>
          <p style="color: #94a3b8; font-size: 0.95rem; line-height: 1.6; margin: 0">{{ dept.description || 'System unit initialized without a functional description.' }}</p>
        </div>
        <div style="margin-top: auto; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.03); display: flex; justify-content: space-between; align-items: center;">
          <span class="dept-badge" style="background: rgba(16, 185, 129, 0.08); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.1);">‚óè OPERATIONAL</span>
          <span style="color: #475569; font-size: 0.7rem; font-family: 'JetBrains Mono'">v1.0.4</span>
        </div>
      </div>
    }
  </div>
</div>

@if (isModalOpen()) {
  <div class="modal-overlay">
    <div class="bento-card" style="width: 100%; max-width: 480px; padding: 40px; border: 1px solid rgba(99, 102, 241, 0.3); transform: none !important;">
      <div style="text-align: center; margin-bottom: 30px">
        <h2 style="color: white; margin: 0; font-size: 1.5rem; font-weight: 800; letter-spacing: -0.5px;">
          {{ isEditMode() ? 'UPDATE' : 'PROVISION' }} <span style="color: #6366f1">UNIT</span>
        </h2>
        <p style="color: #475569; font-size: 0.8rem; margin-top: 5px; font-family: 'JetBrains Mono'">SYSTEM_CONFIG_MODE</p>
      </div>

      <form (ngSubmit)="saveDepartment()" #deptForm="ngForm">
        <div style="margin-bottom: 24px">
          <label class="tf-label">Unit Identity</label>
          <input type="text" name="name" [(ngModel)]="currentDept().name" #nameInput="ngModel" [ngModelOptions]="{ updateOn: 'blur' }" required minlength="3" placeholder="e.g. Logic Engineering" class="tf-input" [style.border-color]="(nameInput.invalid && nameInput.touched) || isNameDuplicate() ? '#ef4444' : ''" style="width: 100%; margin-top: 8px" />
          
          @if (isNameDuplicate()) {
            <span style="color: #ef4444; font-size: 10px; font-weight: 700; margin-top: 4px; display: block;">IDENTITY CONFLICT: NAME ALREADY IN USE</span>
          } @else if (nameInput.invalid && nameInput.touched) {
            <span style="color: #ef4444; font-size: 10px; font-weight: 700; margin-top: 4px; display: block;">NAME IS REQUIRED (MIN. 3 CHARACTERS)</span>
          }
        </div>

        <div style="margin-bottom: 32px">
          <label class="tf-label">Functional Description</label>
          <textarea name="description" [(ngModel)]="currentDept().description" #descInput="ngModel" [ngModelOptions]="{ updateOn: 'blur' }" required minlength="10" rows="4" placeholder="Briefly describe the unit's core purpose..." class="tf-input" [style.border-color]="(descInput.invalid && descInput.touched) || isDescDuplicate() ? '#ef4444' : ''" style="width: 100%; margin-top: 8px; resize: none"></textarea>
          
          @if (isDescDuplicate()) {
            <span style="color: #ef4444; font-size: 10px; font-weight: 700; margin-top: 4px; display: block;">IDENTITY CONFLICT: DESCRIPTION ALREADY IN USE</span>
          } @else if (descInput.invalid && descInput.touched) {
            <span style="color: #ef4444; font-size: 10px; font-weight: 700; margin-top: 4px; display: block;">DESCRIPTION IS REQUIRED (MIN. 10 CHARACTERS)</span>
          }
        </div>

        <div style="display: flex; flex-direction: column; gap: 12px">
          <div style="display: flex; gap: 12px">
            <button type="button" (click)="closeModal()" class="tf-btn-secondary" style="flex: 1">Cancel</button>
            <button type="submit" [disabled]="deptForm.invalid || isNameDuplicate() || isDescDuplicate()" class="tf-btn-primary" style="flex: 2" [style.opacity]="(deptForm.invalid || isNameDuplicate() || isDescDuplicate()) ? '0.5' : '1'" [style.cursor]="(deptForm.invalid || isNameDuplicate() || isDescDuplicate()) ? 'not-allowed' : 'pointer'">
              {{ isEditMode() ? 'Commit Changes' : 'Finalize Unit' }}
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
}